<!doctype html>
<html>

<head>
      <meta charset="utf-8">
    </head>   
    
       
    <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>HelperAI</title>
       
    <link rel="manifest" href="manifest.json">
       
    <meta name="theme-color" content="#0b5">
    <link rel="stylesheet" href="style.css">
</head>

<body>
        <header>
                <div style="display:flex;align-items:center;gap:12px">
                        <img src="logo.png" alt="HelperAI Logo" class="logo" />
                        <strong>HelperAI</strong>
                    </div>
                <div><button id="businessBtn">Business</button></div>
            </header>
        <div id="chat"></div>
        <div id="inputBar">
                <input id="prompt" placeholder="Ask anything...">
                <button id="sendBtn">Send</button>
            </div>
        <div id="bizModal">
                <div class="content">
                    <!-- Business modal (replace your existing biz modal) -->
                        <h3>Business Signup</h3>
                        <label>Name <input id="biz_name" placeholder="Shop name" /></label><br>
                        <label>Email <input id="biz_email" placeholder="owner@example.com" /></label><br>
                        <label>Phone <input id="biz_phone" placeholder="10-digit number" /></label><br>
                        <label>Type
                                <select id="biz_type">
                                        <option>local</option>
                                        <option>global</option>
                                    </select>
                            </label><br>
                        <label>Categories <input id="biz_cat" placeholder="e.g., food,services" /></label><br>
                        <label>Address (optional) <input id="biz_addr" placeholder="Street or landmark" /></label><br>
                        <label>Latitude (optional) <input id="biz_lat" placeholder="e.g., 24.8607" /></label><br>
                        <label>Longitude (optional) <input id="biz_lon" placeholder="e.g., 67.0011" /></label><br>
                        <label>Website (optional) <input id="biz_site" placeholder="https://example.com" /></label><br>
                   
                        <div style="margin-top:8px; display:flex; gap:8px;">
                                <button id="useLocationBtn">Auto-fill my location</button>
                                <button id="bizCreate">Create & Pay ₹2000</button>
                                <button id="bizClose" style="background:#ccc;">Close</button>
                            </div>
                        <div id="bizMsg" style="font-size:13px;color:#444;margin-top:8px"></div>
                    </div>
            </div>
       
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
       
    <script>
        /* ---------- update API_BASE below with your API endpoint after you create API ---------- */
        const API_BASE = "https://qoa89j5onh.execute-api.us-east-1.amazonaws.com/prod"; // e.g. https://abc123.execute-api.region.amazonaws.com/prod

        // Chat
        const chat = document.getElementById('chat');
        const promptInput = document.getElementById('prompt');
        const sendBtn = document.getElementById('sendBtn');

        function addMessage(text, who = 'bot') {
            const d = document.createElement('div');
            d.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
            d.innerHTML = text;
            chat.appendChild(d);
            chat.scrollTop = chat.scrollHeight;
        }

    // Store session_id in browser localStorage
    let sessionId = localStorage.getItem("session_id");
    if (!sessionId) {
        sessionId = crypto.randomUUID();
        localStorage.setItem("session_id", sessionId);
    }

    sendBtn.onclick = async () => {
        const text = promptInput.value.trim();
        if (!text) return;
        addMessage(text, 'user');
        promptInput.value = '';
        addMessage('Thinking...', 'bot');

        let loc = null;
        try {
            const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 5000 }));
            loc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        } catch (e) { }

        const payload = { session_id: sessionId, prompt: text, lat: loc?.lat, lon: loc?.lon };
        const res = await fetch(API_BASE + '/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();

        // remove last "Thinking..."
        const msgs = Array.from(document.getElementsByClassName('msg'));
        if (msgs.length) chat.removeChild(msgs[msgs.length - 1]);

        addMessage(data.answer || "No response", 'bot');
    };


        // Modal logic
        document.getElementById('businessBtn').onclick = () => document.getElementById('bizModal').style.display = 'flex';
        document.getElementById('bizClose').onclick = () => document.getElementById('bizModal').style.display = 'none';
        document.getElementById('useLocationBtn').onclick = async () => {
            document.getElementById('bizMsg').innerText = 'Getting location…';
            try {
                const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 7000 }));
                document.getElementById('biz_lat').value = pos.coords.latitude;
                document.getElementById('biz_lon').value = pos.coords.longitude;
                document.getElementById('bizMsg').innerText = 'Location filled';
            } catch (e) {
                document.getElementById('bizMsg').innerText = 'Could not get location. Enter manually.';
            }
        };

        
            document.getElementById('bizCreate').onclick = async () => {
                document.getElementById('bizMsg').innerText = 'Creating signup...';
                const payload = {
                    name: document.getElementById('biz_name').value,
                    email: document.getElementById('biz_email').value,
                    phone: document.getElementById('biz_phone').value,
                    type: document.getElementById('biz_type').value,
                    categories: document.getElementById('biz_cat').value,
                    address: document.getElementById('biz_addr').value,
                    lat: document.getElementById('biz_lat').value || null,
                    lon: document.getElementById('biz_lon').value || null,
                    website: document.getElementById('biz_site').value || null
                };

                // simple validation
                if (!payload.name || !payload.phone || !payload.email) {
                    document.getElementById('bizMsg').innerText = 'Please enter Name, Phone, Email.';
                    return;
                }

                // call backend to create business record and razorpay order
                try {
                    const resp = await fetch(API_BASE + '/business/signup', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const j = await resp.json();
                    if (!j || !j.order_id) {
                        document.getElementById('bizMsg').innerText = 'Server error creating order: ' + (j?.error || 'unknown');
                        return;
                    }

                    // open Razorpay Checkout with returned order_id and key
                    const options = {
                        key: j.razorpay_key, // razorpay key id from server
                        order_id: j.order_id,
                        name: payload.name,
                        description: 'Business subscription ₹2000 / month',
                        handler: async function (razorResp) {
                            // razorResp contains razorpay_payment_id, razorpay_order_id, razorpay_signature
                            document.getElementById('bizMsg').innerText = 'Verifying payment...';
                            // send payment id to server to verify & activate business
                            const verify = await fetch(API_BASE + '/business/verify_payment', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ razorpay_payment_id: razorResp.razorpay_payment_id, business_id: j.business_id })
                            });
                            const v = await verify.json();
                            if (v && v.ok) {
                                document.getElementById('bizMsg').innerText = 'Payment successful. Your business is active for 30 days.';
                            } else {
                                document.getElementById('bizMsg').innerText = 'Payment verification failed. Contact support.';
                            }
                        },
                        prefill: { name: payload.name, email: payload.email, contact: payload.phone },
                        theme: { color: "#0b5" }
                    };
                    const rzp = new Razorpay(options);
                    rzp.open();
                } catch (e) {
                    document.getElementById('bizMsg').innerText = 'Network/server error: ' + e.message;
                }
            };
    </script>

            <!-- Register service worker -->
       
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js")
                .then(() => console.log("SW registered"))
                .catch(err => console.error("SW failed", err));
        }
    </script>
    <script>
    let deferredPrompt;
    window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.createElement("button");
        btn.textContent = "Install App";
        btn.className = "install-btn";
        btn.onclick = async () => {
            btn.style.display = "none";
            deferredPrompt.prompt();
            const choice = await deferredPrompt.userChoice;
            if (choice.outcome !== "accepted") btn.style.display = "block";
        };
        document.body.appendChild(btn);
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
    function addMessage(text, who = 'bot', format = 'text') {
        const d = document.createElement('div');
        d.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
        d.innerHTML = (format === 'markdown') ? marked.parse(text) : text;
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
    }
    </script>


</body>

</html>